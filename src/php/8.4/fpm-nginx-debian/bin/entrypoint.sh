#!/bin/bash
set -e

echo "[ENTRYPOINT] Starting bootstrapping process...";

# Configurable default values
DEFAULT_NGINX_CERT_PATH="/var/www/certs/cert.pem"
DEFAULT_NGINX_KEY_PATH="/var/www/certs/key.pem"
DEFAULT_MAX_UPLOAD_SIZE="100M"
DEFAULT_MEMORY_LIMIT="1024M"
DEFAULT_PHP_PROD_DISPLAY_ERRORS="Off"
DEFAULT_PHP_PROD_DISPLAY_STARTUP_ERRORS="Off"
DEFAULT_PHP_WORKER_PROCESS_COUNT="1"
DEFAULT_PHP_FPM_MAX_CHILDREN="20"
DEFAULT_PHP_FPM_START_SERVERS="2"
DEFAULT_PHP_FPM_MIN_SPARE_SERVERS="1"
DEFAULT_PHP_FPM_MAX_SPARE_SERVERS="4"
DEFAULT_PHP_FPM_MAX_REQUESTS="500"

# Determine effective max upload size
MAX_UPLOAD_SIZE_EFFECTIVE="${MAX_UPLOAD_SIZE:-$DEFAULT_MAX_UPLOAD_SIZE}"

# Load environment variables
export NGINX_CLIENT_MAX_BODY_SIZE="${NGINX_CLIENT_MAX_BODY_SIZE:-$MAX_UPLOAD_SIZE_EFFECTIVE}"
export NGINX_CERT_PATH="${NGINX_CERT_PATH:-$DEFAULT_NGINX_CERT_PATH}"
export NGINX_KEY_PATH="${NGINX_KEY_PATH:-$DEFAULT_NGINX_KEY_PATH}"
export PHP_TIMEZONE="${PHP_TIMEZONE:-${TZ}}" # TZ is by default UTC
export PHP_UPLOAD_MAX_FILESIZE="${PHP_UPLOAD_MAX_FILESIZE:-$MAX_UPLOAD_SIZE_EFFECTIVE}"
export PHP_POST_MAX_SIZE="${PHP_POST_MAX_SIZE:-$MAX_UPLOAD_SIZE_EFFECTIVE}"
export PHP_MEMORY_LIMIT="${PHP_MEMORY_LIMIT:-$DEFAULT_MEMORY_LIMIT}"
export PHP_PROD_DISPLAY_ERRORS="${PHP_PROD_DISPLAY_ERRORS:-$DEFAULT_PHP_PROD_DISPLAY_ERRORS}"
export PHP_PROD_DISPLAY_STARTUP_ERRORS="${PHP_PROD_DISPLAY_STARTUP_ERRORS:-$DEFAULT_PHP_PROD_DISPLAY_STARTUP_ERRORS}"
export PHP_WORKER_PROCESS_COUNT="${PHP_WORKER_PROCESS_COUNT:-$DEFAULT_PHP_WORKER_PROCESS_COUNT}"
export PHP_FPM_MAX_CHILDREN="${PHP_FPM_MAX_CHILDREN:-$DEFAULT_PHP_FPM_MAX_CHILDREN}"
export PHP_FPM_START_SERVERS="${PHP_FPM_START_SERVERS:-$DEFAULT_PHP_FPM_START_SERVERS}"
export PHP_FPM_MIN_SPARE_SERVERS="${PHP_FPM_MIN_SPARE_SERVERS:-$DEFAULT_PHP_FPM_MIN_SPARE_SERVERS}"
export PHP_FPM_MAX_SPARE_SERVERS="${PHP_FPM_MAX_SPARE_SERVERS:-$DEFAULT_PHP_FPM_MAX_SPARE_SERVERS}"
export PHP_FPM_MAX_REQUESTS="${PHP_FPM_MAX_REQUESTS:-$DEFAULT_PHP_FPM_MAX_REQUESTS}"

# If the PHP_WORKER_COMMAND is set, set the CONTAINER_MODE environment variable to "worker", otherwise set it to "web"
if [ -n "${PHP_WORKER_COMMAND}" ]; then
  export CONTAINER_MODE="worker"
else
  export CONTAINER_MODE="web"
fi

# Configure services
echo "[ENTRYPOINT] Configuring services in mode: ${CONTAINER_MODE}...";

ENTRYPOINT_DIR="$(dirname $(realpath "${BASH_SOURCE[0]}"))/entrypoint"
source "${ENTRYPOINT_DIR}/util/render-template.sh"
source "${ENTRYPOINT_DIR}/user-setup.sh"
source "${ENTRYPOINT_DIR}/php.sh"
source "${ENTRYPOINT_DIR}/nginx.sh"
source "${ENTRYPOINT_DIR}/supervisor.sh"
source "${ENTRYPOINT_DIR}/custom.sh"

echo "[ENTRYPOINT] Bootstrapping completed, starting command...";
exec "$@"
