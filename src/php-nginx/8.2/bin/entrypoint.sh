#!/bin/bash
set -e

echo "[ENTRYPOINT] Starting PHP bootstrapping process...";

ENTRYPOINT_DIR="$(dirname $(realpath "${BASH_SOURCE[0]}"))/entrypoint"
source "${ENTRYPOINT_DIR}/util/utils.sh"

# Load environment variables
echo "[ENTRYPOINT] Effective configuration:";

export ENVIRONMENT="$(find_environment)"
echo "   - ENVIRONMENT=${ENVIRONMENT}";
export NGINX_DOC_ROOT="${NGINX_DOC_ROOT:-"/var/www/html/public"}"
echo "   - NGINX_DOC_ROOT=${NGINX_DOC_ROOT}";
export NGINX_CLIENT_MAX_BODY_SIZE="${NGINX_CLIENT_MAX_BODY_SIZE:-${MAX_UPLOAD_SIZE:-"100M"}}"
echo "   - NGINX_CLIENT_MAX_BODY_SIZE=${NGINX_CLIENT_MAX_BODY_SIZE}";
export NGINX_CERT_PATH="${NGINX_CERT_PATH:-"/etc/ssl/certs/cert.pem"}"
echo "   - NGINX_CERT_PATH=${NGINX_CERT_PATH}";
export NGINX_KEY_PATH="${NGINX_KEY_PATH:-"/etc/ssl/certs/key.pem"}"
echo "   - NGINX_KEY_PATH=${NGINX_KEY_PATH}";
export PHP_TIMEZONE="${PHP_TIMEZONE:-${TZ}}" # TZ is by default UTC
echo "   - NGINX_KEY_PATH=${NGINX_KEY_PATH}";
export PHP_UPLOAD_MAX_FILESIZE="${PHP_UPLOAD_MAX_FILESIZE:-${MAX_UPLOAD_SIZE:-"100M"}}"
echo "   - PHP_UPLOAD_MAX_FILESIZE=${PHP_UPLOAD_MAX_FILESIZE}";
export PHP_POST_MAX_SIZE="${PHP_POST_MAX_SIZE:-${MAX_UPLOAD_SIZE:-"100M"}}"
echo "   - PHP_POST_MAX_SIZE=${PHP_POST_MAX_SIZE}";
export PHP_MEMORY_LIMIT="${PHP_MEMORY_LIMIT:-"1024M"}"
echo "   - PHP_MEMORY_LIMIT=${PHP_MEMORY_LIMIT}";
export PHP_PROD_DISPLAY_ERRORS="${PHP_PROD_DISPLAY_ERRORS:-"Off"}"
echo "   - PHP_PROD_DISPLAY_ERRORS=${PHP_PROD_DISPLAY_ERRORS}";
export PHP_PROD_DISPLAY_STARTUP_ERRORS="${PHP_PROD_DISPLAY_STARTUP_ERRORS:-"Off"}"
echo "   - PHP_PROD_DISPLAY_STARTUP_ERRORS=${PHP_PROD_DISPLAY_STARTUP_ERRORS}";
export PHP_WORKER_PROCESS_COUNT="${PHP_WORKER_PROCESS_COUNT:-"1"}"
echo "   - PHP_WORKER_PROCESS_COUNT=${PHP_WORKER_PROCESS_COUNT}";
export PHP_FPM_MAX_CHILDREN="${PHP_FPM_MAX_CHILDREN:-"20"}"
echo "   - PHP_FPM_MAX_CHILDREN=${PHP_FPM_MAX_CHILDREN}";
export PHP_FPM_START_SERVERS="${PHP_FPM_START_SERVERS:-"2"}"
echo "   - PHP_FPM_START_SERVERS=${PHP_FPM_START_SERVERS}";
export PHP_FPM_MIN_SPARE_SERVERS="${PHP_FPM_MIN_SPARE_SERVERS:-"1"}"
echo "   - PHP_FPM_MIN_SPARE_SERVERS=${PHP_FPM_MIN_SPARE_SERVERS}";
export PHP_FPM_MAX_SPARE_SERVERS="${PHP_FPM_MAX_SPARE_SERVERS:-"4"}"
echo "   - PHP_FPM_MAX_SPARE_SERVERS=${PHP_FPM_MAX_SPARE_SERVERS}";
export PHP_FPM_MAX_REQUESTS="${PHP_FPM_MAX_REQUESTS:-"500"}"
echo "   - PHP_FPM_MAX_REQUESTS=${PHP_FPM_MAX_REQUESTS}";
export APP_ENV="${APP_ENV:-${ENVIRONMENT}}"
echo "   - APP_ENV=${APP_ENV}";
export DOCKER_PROJECT_HOST="${DOCKER_PROJECT_HOST:-localhost}"
echo "   - DOCKER_PROJECT_HOST=${DOCKER_PROJECT_HOST}";
export DOCKER_PROJECT_PROTOCOL="${DOCKER_PROJECT_PROTOCOL:-http}"
echo "   - DOCKER_PROJECT_PROTOCOL=${DOCKER_PROJECT_PROTOCOL}";
export DOCKER_PROJECT_PATH="${DOCKER_PROJECT_PATH:-/}"
echo "   - DOCKER_PROJECT_PATH=${DOCKER_PROJECT_PATH}";
export DOCKER_SERVICE_PROTOCOL="${DOCKER_SERVICE_PROTOCOL:-${DOCKER_PROJECT_PROTOCOL}}"
echo "   - DOCKER_SERVICE_PROTOCOL=${DOCKER_SERVICE_PROTOCOL}";
export DOCKER_SERVICE_PATH="${DOCKER_SERVICE_PATH:-/}"
echo "   - DOCKER_SERVICE_PATH=${DOCKER_SERVICE_PATH}";
export DOCKER_SERVICE_ABS_PATH="$(join_paths "${DOCKER_PROJECT_PATH:-/}" "${DOCKER_SERVICE_PATH}")"
echo "   - DOCKER_SERVICE_ABS_PATH=${DOCKER_SERVICE_ABS_PATH}";

# If the PHP_WORKER_COMMAND is set, set the CONTAINER_MODE environment variable to "worker", otherwise set it to "web"
if [ -n "${PHP_WORKER_COMMAND}" ]; then
  export CONTAINER_MODE="worker"
  echo "   - CONTAINER_MODE=${CONTAINER_MODE}";
else
  export CONTAINER_MODE="web"
  echo "   - CONTAINER_MODE=${CONTAINER_MODE}";
fi

# Setting directories for later use
export NGINX_DIR="/etc/nginx"
export NGINX_SNIPPET_DIR="$NGINX_DIR/snippets"
export NGINX_SERVICE_SNIPPET_DIR="${NGINX_SNIPPET_DIR}/service.d"
export NGINX_GLOBAL_SNIPPET_DIR="${NGINX_SNIPPET_DIR}/global.d"
export NGINX_TEMPLATE_DIR="${CONTAINER_TEMPLATE_DIR}/nginx"
export NGINX_CUSTOM_TEMPLATE_DIR="${NGINX_TEMPLATE_DIR}/custom"
export NGINX_CUSTOM_GLOBAL_TEMPLATE_DIR="${NGINX_CUSTOM_TEMPLATE_DIR}/global"
export SUPERVISOR_TEMPLATE_DIR="${CONTAINER_TEMPLATE_DIR}/supervisor"
export SUPERVISOR_CONFIG_DIR="/etc/supervisor/conf.d"
export PHP_TEMPLATE_DIR="${CONTAINER_TEMPLATE_DIR}/php"
export PHP_CUSTOM_TEMPLATE_DIR="${CONTAINER_TEMPLATE_DIR}/php/custom"
export PHP_CONFIG_DIR="/usr/local/etc/php/conf.d"
export PHP_FPM_CONFIG_DIR="/usr/local/etc/php-fpm.d"

# Configure services
echo "[ENTRYPOINT] Configuring services...";

source "${ENTRYPOINT_DIR}/user-setup.sh"
source "${ENTRYPOINT_DIR}/php.sh"
source "${ENTRYPOINT_DIR}/nginx.sh"
source "${ENTRYPOINT_DIR}/supervisor.sh"
source "${ENTRYPOINT_DIR}/custom.sh"

echo "[ENTRYPOINT] Bootstrapping completed, starting command \"$@\"...";
exec "$@"
